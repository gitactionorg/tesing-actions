# .github/workflows/update-commit-sha.yml new
name: Update commit_sha.txt

on:
  workflow_call:

jobs:
  update-commit-sha:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN}}
        
      - name: Append commit SHA to file
        run: |
          echo "${GITHUB_SHA}" >> commit_sha.txt
      
      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Commit changes
        run: |
          # git add commit_sha.txt
          # git commit -m "Add commit SHA ${GITHUB_SHA}"
          # # git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          # git push origin HEAD
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
            git checkout -b update-image-digest-${{ github.sha }}
            git add commit_sha.txt
            git commit -m "Add Docker image tag and digest [ci skip]"
            git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            git push origin HEAD:update-image-digest-${{ github.sha }}
        
            # Create a pull request
            gh pr create --title "Update image digest" --head update-image-digest-${{ github.sha }} --base master
        
            # Auto-merge the PR and delete the branch
            PR_NUMBER=$(gh pr list --state open --head update-image-digest-${{ github.sha }} --json number --jq '.[0].number')
            gh pr merge $PR_NUMBER --merge
            git push origin --delete update-image-digest-${{ github.sha }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
   
